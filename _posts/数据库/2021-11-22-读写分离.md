---
layout: post
title: 读写分离
categories: [数据库]
description: 读写分离
keywords: 数据库, 读写分离
---

面对日益增加的系统访问量，数据库的吞吐量面临着巨大瓶颈。 对于同一时刻有大量并发读操作和较少写操作类型的应用系统来说，将数据库拆分为主库和从库，主库负责处理事务性的增删改操作，从库负责处理查询操作，**能够有效的避免由数据更新导致的行锁，使得整个系统的查询性能得到极大的改善。**

通过一主多从的配置方式，可以将查询请求均匀的分散到多个数据副本，能够进一步的提升系统的处理能力。 使用多主多从的方式，不但能够提升系统的吞吐量，还能够提升系统的可用性，可以达到在任何一个数据库宕机，甚至磁盘物理损坏的情况下仍然不影响系统的正常运行。

与将数据根据分片键打散至各个数据节点的水平分片不同，读写分离则是根据SQL语义的分析，将读操作和写操作分别路由至主库与从库。

![背景](https://gitee.com/dxyin/pic/raw/master/20211123094143.png)

**读写分离的数据节点中的数据内容是一致的，而水平分片的每个数据节点的数据内容却并不相同。将水平分片和读写分离联合使用，能够更加有效的提升系统性能。**

### 中间件

读写分离的中间件常见有canal、altas、sharding-jdbc等，下面我们只讲sharding-jdbc，原理差不多。以下是sharding-jdbc读写分离的基本概念。

#### 主库

添加、更新以及删除数据操作所使用的数据库，sharding-jdbc目前仅支持单主库。

#### 从库

查询数据操作所使用的数据库，可支持多从库。

#### 主从同步

将主库的数据异步的同步到从库的操作。 由于主从同步的异步性，从库与主库的数据会短时间内不一致。

#### 负载均衡策略

通过负载均衡策略将查询请求疏导至不同从库，常见的有轮询策略和随机策略。

#### 支持项

- 提供一主多从的读写分离配置，可独立使用，也可配合数据分片使用；
- 事务中的数据读写均用主库；
- 基于 Hint 的强制主库路由

#### 不支持项

- **主库和从库的数据同步**，需要借助其它中间件进行同步
- 主库和从库的数据同步延迟导致的数据不一致；
- 主库多写；
- 主从库间的事务一致性。主从模型中，事务中的数据读写均用主库。

### 存在的问题

读写分离虽然可以提升系统的吞吐量和可用性，但同时也带来了数据不一致的问题。 这包括多个主库之间的数据一致性，以及主库与从库之间的数据一致性的问题。

 并且，读写分离也带来了与数据分片同样的问题，它同样会使得应用开发和运维人员对数据库的操作和运维变得更加复杂。 

下图展现了将数据分片与读写分离一同使用时，应用程序与数据库集群之间的复杂拓扑关系。

![挑战](https://gitee.com/dxyin/pic/raw/master/20211123094338.png)

