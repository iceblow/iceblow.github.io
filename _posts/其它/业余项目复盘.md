---
layout: post
title: 业余项目复盘
categories: [其它]
description: 微信支付
keywords: 微信支付, 公众号
---

最近朋友有个小项目需要做微信公众号信支付和微信广告回传，时间要求2天内服务端接口基本功能完成，能和前端联调微信支付和广告回传。

但是朋友没有微信这块的开发经验，所以找到了我。我了解他的具体需求后，也是一脸懵逼，当前存在的问题如下：

- 无微信支付的源码，只能找开源项目
- 不了解微信广告回传流程
- 时间紧急只有2天

我心里也是没底，只能硬着头皮上。所以抓紧时间查阅微信公众号的开发文档，了解基本流程后，梳理了服务端的接口。

### 基础概念

#### 广告回传

微信官方书面语是行为数据回传，在[微信广告](https://ad.weixin.qq.com/guide/(https://mp.weixin.qq.com/))，以下简称MP投放端，推广公众号时，用户关注公众号之后会产生对应的转化行为（如下单、资料收集、注册等），**为了量化关注类广告关注粉丝的转化效果，需要回传用户的转化行为。本API解决的是公众号内部转化行为回传的问题**。

### 行为回传

#### 准备

##### 注册开发者

微信公共平台 - 开发 - 基本配置，注册为开发者

##### 创建数据源

1. 构造请求，创建数据源；
2. 保存数据源ID，用于后续回传数据；

#### 正式对接

##### 获取用户openid

获取用户openid，详见[openid获取说明](https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html)

这里我们只需要静默授权后获取用户的openid，不需要拉取用户的详细信息。

![image-20220311102348187](https://img-1257951221.cos.ap-shanghai.myqcloud.com//20220311102348.png)

服务端代码如下：

```java
  /**
   * 授权code获取openID
   *
   * @param code
   * @return
   */
  public static OpenIdAuthDO code2access_token(String code) {

    StringBuilder url = new StringBuilder("https://api.weixin.qq.com/sns/oauth2/access_token?appid=");
    url.append(GlobalConst.GongZhongHao.appid);
    url.append("&secret=").append(GlobalConst.GongZhongHao.appSecret);
    url.append("&code=").append(code);
    url.append("&grant_type=authorization_code");

    WxOpenIdResponse json = Forest.post(url.toString())
      .contentTypeJson()
      .execute(WxOpenIdResponse.class);
    if (json.getErrcode() != 0) {
      log.info("授权code获取openID error, msg:{}", json.getErrmsg());
      throw new RuntimeException(json.getErrmsg());
    } else {
      log.info("授权code获取openID ok, response:{}", json.toString());
    }

    OpenIdAuthDO openIdAuthDO = new OpenIdAuthDO();
    openIdAuthDO.setOpenid(json.getOpenid());
    openIdAuthDO.setScope(json.getScope());
    return openIdAuthDO;
  }：
```

##### 获取access_token

参考说明文档[获取access_token](https://developers.weixin.qq.com/minigame/dev/api-backend/open-api/access-token/auth.getAccessToken.html)

代码如下：

```java
/**
   * 公众号获取access_token
   *
   * @return
   */
  public static AccessTokenResponse accessToken() {

    StringBuilder url = new StringBuilder("https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=");
    url.append(GlobalConst.GongZhongHao.appid);
    url.append("&secret=").append(GlobalConst.GongZhongHao.appSecret);

    AccessTokenResponse accessToken = Forest.get(url.toString())
      .contentTypeJson()
      .execute(AccessTokenResponse.class);
    if (accessToken.getAccess_token() == null) {
      log.error("获取令牌 error, response:{}", accessToken.toString());
      throw new RuntimeException(accessToken.getErrmsg());
    } else {
      log.info("获取令牌 ok, token:{}, expireIn:{}", accessToken.getAccess_token(), accessToken.getExpires_in());
    }
    return accessToken;
  }

```

需要注意的是，access_token过期时间为2h，服务端需要把token缓存起来，然后定时主动刷新或者被动获取新token。

##### 创建数据源

目标：创建数据源，生成数据源ID（user_action_set_id） 步骤：

1. 构造请求，创建数据源；
2. 保存数据源ID，用于后续回传数据；

获取数据源就不需要写服务端接口了，直接postman调用拿到数据源ID，保存到配置文件。

![image-20220311104434688](https://img-1257951221.cos.ap-shanghai.myqcloud.com//20220311104434.png)

##### 行为回传

**目标**：根据openid、Action_Type、创建时保存的数据源ID，调用API进行回传，获取成功应答；

**步骤**：

1. 前提 在传入转化行为数据之前，请确保开发者已经：

- 注册成为开发者，并获取了可用的在有效期内的token
- 已创建数据源，并保留user_action_set_id。

需要的部分参数如下：

![image-20220311104856552](https://img-1257951221.cos.ap-shanghai.myqcloud.com//20220311104856.png)

代码如下：

```java
/**
   * 行为回传
   *
   * @return
   */
  public static void adUserActions(String accessToken, UserActionReq req) {
    WxUserActionDO actionDO = new WxUserActionDO();
    actionDO.setUser_action_set_id(GlobalConst.GongZhongHao.user_action_set_id);
    actionDO.setUrl(req.getUrl());
    actionDO.setAction_time(System.currentTimeMillis() / 1000);
    actionDO.setAction_type(req.getAction_type());
    actionDO.setValue(req.getValue());

    WxUserActionDO.UserId userId = new WxUserActionDO.UserId();
    userId.setWechat_app_id(GlobalConst.GongZhongHao.appid);
    userId.setWechat_openid(req.getOpenid());
    actionDO.setUser_id(userId);

    WxUserActionDO.ActionParam actionParam = new WxUserActionDO.ActionParam();
    actionParam.setSource("Biz");
    actionParam.setClaim_type(req.getClaim_type());
    actionParam.setValue(req.getValue());
    actionDO.setAction_param(actionParam);

    StringBuilder url = new StringBuilder("https://api.weixin.qq.com/marketing/user_actions/add?version=v1.0&access_token=");
    url.append(accessToken);

    WxUserActionDO[] actionDOS = new WxUserActionDO[1];
    actionDOS[0] = actionDO;

    WxResponse response = Forest.post(url.toString())
      .addBody("actions", actionDOS)
      .contentTypeJson()
      .execute(WxResponse.class);
    if (response.getErrcode() != 0) {
      log.error("用户行为回传 error, response:{}", response.toString());
      throw new RuntimeException(response.getErrmsg());
    } else {
      log.info("用户行为回传 ok, response:{}", response.toString());
    }
  }
```

### 微信支付

#### 准备工作

需要开通微信商户，准备相关配置，详细说明见开发文档https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=7_3

##### 一、设置支付目录

商户最后请求拉起微信支付收银台的页面地址我们称之为“支付目录”，例如：https://www.weixin.com/pay.php。商户实际的支付目录必须和在微信支付商户平台设置的一致，否则会报错“当前页面的URL未注册。

##### 二、设置授权域名

开发JSAPI支付时，在统一下单接口中要求必传用户openid，而获取openid则需要您在公众平台设置[获取openid](https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html)的域名，只有被设置过的域名才是一个有效的获取openid的域名，否则将获取失败。

#### 支付方式

微信支付的支付方式有多种，详细介绍如下。

##### 付款码支付

付款码支付是用户展示微信钱包内的“刷卡条码/二维码”给商户系统扫描后直接完成支付的模式。主要应用线下面对面收银的场景。

##### Native支付

Native支付是商户系统按微信支付协议生成支付二维码，用户再用微信“扫一扫”完成支付的模式。该模式适用于PC网站支付、实体店单品或订单支付、媒体广告支付等场景。

##### JSAPI支付

JSAPI支付是用户在微信中打开商户的H5页面，商户在H5页面通过调用微信支付提供的JSAPI接口调起微信支付模块完成支付。应用场景有：

1. ◆ 用户在微信公众账号内进入商家公众号，打开某个主页面，完成支付
2. ◆ 用户的好友在朋友圈、聊天窗口等分享商家页面链接，用户点击链接打开商家页面，完成支付
3. ◆ 将商户页面转换成二维码，用户扫描二维码后在微信浏览器中打开页面后完成支付

##### APP支付

APP支付又称移动端支付，是商户通过在移动端应用APP中集成开放SDK调起微信支付模块完成支付的模式。

##### H5支付

H5支付主要是在手机、ipad等移动设备中通过浏览器来唤起微信支付的支付产品。

##### 小程序支付

小程序支付是专门被定义使用在小程序中的支付产品。目前在小程序中能且只能使用小程序支付的方式来唤起微信支付。

#### JSAPI支付流程

这里只讲本次开发公众号支付用到的JSAPI支付流程，其他支付方式可以查阅微信支付开发文档。

以下是支付场景的交互细节，请认真阅读，设计商户页面的逻辑：

（1）用户打开商户网页选购商品，发起支付，在网页通过JavaScript调用getBrandWCPayRequest接口，发起微信支付请求，用户进入支付流程。

（2）用户成功支付点击完成按钮后，商户的前端会收到JavaScript的返回值。商户可直接跳转到支付成功的静态页面进行展示。

（3）商户后台收到来自微信开放平台的支付成功回调通知，标志该笔订单支付成功。

注：（2）和（3）的触发不保证遵循严格的时序。JS API返回值作为触发商户网页跳转的标志，但商户后台应该只在收到微信后台的支付成功回调通知后，才做真正的支付成功的处理。

##### 时序图

![666](https://img-1257951221.cos.ap-shanghai.myqcloud.com//20220311170129.jpeg)

商户系统和微信支付系统主要交互：

1、商户server调用统一下单接口请求订单，api参见公共api【[统一下单API](https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=9_1)】

2、商户server可通过【[JSAPI调起支付API](https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=7_7&index=6)】调起微信支付，发起支付请求。

3、商户server接收支付通知，api参见公共api【[支付结果通知API](https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=9_7)】

4、商户server查询支付结果，api参见公共api【[查询订单API](https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=9_2)】（查单实现可参考：[支付回调和查单实现指引](https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=23_9&index=1)）

#### 正式对接

在Gitee找个微信支付的开源项目https://gitee.com/binary/weixin-java-tools.git，这个是微信`Java`开发工具包，支持包括微信支付、开放平台、公众号、企业微信/企业号、小程序等微信功能模块的后端开发。

demo项目地址https://gitee.com/binary/weixin-java-pay-demo.git，本 Demo 基于 `WxJava` 和 `Spring Boot` 构建，演示微信支付后端接口使用方法。

服务端代码如下，内部逻辑自己实现。

##### 统一下单

```java
/**
   * 调用统一下单接口，并组装生成支付所需参数对象.
   *
   * @param request 统一下单请求参数
   * @return 返回 {@link com.github.binarywang.wxpay.bean.order}包下的类对象
   */
  @ApiOperation(value = "统一下单，并组装所需支付参数")
  @PostMapping("/createOrder")
  public ResponseData createOrder(@RequestBody WxPayUnifiedOrderRequest request) throws WxPayException {
    if (StringUtils.isEmpty(request.getOpenid())) {
      return ResponseData.fail("openid必传");
    }
    log.info("统一下单请求:{}", JSON.toJSONString(request));
    request.setOutTradeNo(System.currentTimeMillis() + "");
    request.setNotifyUrl(wxPayProperties.getOrderNotifyUrl());

    WxPayMpOrderResult wxOrderResult = this.wxService.createOrder(request);
    orderThreadPool.executeTask(() -> {
      wxOrderManager.saveOrder(request, wxOrderResult);
    });
    return ResponseData.ok(wxOrderResult);
  }
```

##### 支付回调

```java
@ApiOperation(value = "支付回调通知处理")
  @PostMapping("/notify/order")
  public String parseOrderNotifyResult(@RequestBody String xmlData) throws WxPayException {
    final WxPayOrderNotifyResult notifyResult = this.wxService.parseOrderNotifyResult(xmlData);
    try {
      wxOrderManager.notifyOrder(notifyResult);
    } catch (Exception e) {
      log.error("订单回调后处理异常, notifyResult:{}", JSON.toJSONString(notifyResult), e);
    }
    return WxPayNotifyResponse.success("成功");
  }


```

##### 查询订单

```java
  /**
   * <pre>
   * 查询订单(详见https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=9_2)
   *
   * @param transactionId 微信订单号
   * @param outTradeNo    商户系统内部的订单号，当没提供transactionId时需要传这个。
   */
  @ApiOperation(value = "查询订单")
  @GetMapping("/queryOrder")
  public ResponseData<WxPayOrderQueryResult> queryOrder(@RequestParam(required = false) String transactionId,
                                                        @RequestParam(required = false) String outTradeNo)
    throws WxPayException {
    WxPayOrderQueryResult queryResult = this.wxService.queryOrder(transactionId, outTradeNo);
    return ResponseData.ok(queryResult);
  }
```

##### 订单退款

```java
  /**
   * 退款
   *
   * @param request
   * @return
   * @throws WxPayException
   */
  @ApiOperation(value = "退款")
  @PostMapping("/refund")
  public ResponseData<WxPayRefundResult> refund(@RequestBody WxPayRefundRequest request) throws WxPayException {
    return ResponseData.ok(this.wxService.refund(request));
  }
```

退款环节有个地方需要注意：用户支付的资金并没有到商家账户，而是到了微信平台账户（需要和商户结算），如果商家账户没钱了，我们先付款，然后退款，这样是退款失败的，提示商户资金不足，需要先充值后才能退款。

### 小结

历时2天的高强度加班（搞到半夜2点），项目流程终于跑通，后续其他需求和优化交给朋友负责了，哈哈。

整个项目的难度就是要查阅微信开发文档，梳理流程，代码量并不是很多。最大的挑战就是微信支付了，还好有开源项目，不用从零开发，主要做支付配置和对接调试，在此非常感谢开源项目。

这里主要是做个项目复盘，形成闭环。
