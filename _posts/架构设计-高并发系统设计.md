提到互联⽹系统设计，老生常谈的就是“三⾼”，也就是“⾼并发”“⾼性能”“⾼可 ⽤”，它们是互联⽹系统架构设计永恒的主题。

⾼并发，是指让系统能够处理更多的⽤户并发请求，也就是承担更⼤的流量。 它是⼀切架构设计的背景和前提。⽽性能和可⽤性，是我们实现⾼并发系统设计必须考虑的因素。

⾼并发系统设计的三⼤⽬标：**⾼性能、⾼可⽤、可扩展**。

性能反映了系统的使⽤体验，想象⼀下，同样承担每秒⼀万次请求的两个系统，⼀个响应时 间是毫秒级，⼀个响应时间在秒级别，它们带给⽤户的体验肯定是不同的。

可⽤性则表示系统可以正常服务⽤户的时间。我们再类⽐⼀下，还是两个承担每秒⼀万次的系统，⼀个可以做到全年不停机、⽆故障，⼀个隔三差五宕机维护，如果你是⽤户，你会选 择使⽤哪⼀个系统呢？答案不⾔⽽喻。

另⼀个⽿熟能详的名词叫“可扩展性”，它同样是⾼并发系统设计需要考虑的因素。举⼀个具体的例⼦。

流量分为平时流量和峰值流量两种，峰值流量可能会是平时流量的⼏倍甚⾄⼏⼗倍，在应对峰值流量的时候，我们通常需要在架构和⽅案上做更多的准备。这就是淘宝会花费⼤半年的 时间准备双⼗⼀，也是在⾯对“明星离婚”等热点事件时，看起来⽆懈可击的微博系统还是会出现服务不可⽤的原因。⽽易于扩展的系统能在短时间内迅速完成扩容，更加平稳地承担 峰值量。 

那么如何提升系统的性能？

### 性能优化原则

⾸先，性能优化⼀定不能盲⽬，⼀定是问题导向的。脱离了问题，盲⽬地提早优化会增加系 统的复杂度，浪费开发⼈员的时间。 

其次，性能优化也要有数据⽀撑。在优化过程中，你要时刻了解你的优化让响应时间减少了 多少，提升了多少的吞吐量。

最后，性能优化的过程是持续的。

### 性能的度量指标

对于性能我们需要有度量的标准，有了数据才能明确⽬前存在的性能问题，也能够⽤数据来评估性能优化的效果。所以明确性能的度量指标⼗分重要。

⼀般来说，度量性能的指标是系统接⼝的响应时间，但是单次的响应时间是没有意义的，你 需要知道⼀段时间的性能情况是什么样的。所以，我们需要收集这段时间的响应时间数据， 然后依据⼀些统计⽅法计算出特征值，这些特征值就能够代表这段时间的性能情况。我们常 ⻅的特征值有以下⼏类。

#### 平均值

平均值是把这段时间所有请求的响应时间数据相加，再除以总请求数。平均值可 以在⼀定程度上反应这段时间的性能，但它敏感度⽐较差，如果这段时间有少量慢请求时， 在平均值上并不能如实地反应。

举个例子，假设我们在 30s 内有 10000 次请求，每次响应时间是 1ms，那么这段时间平均值也是 1ms。当其中 100 次请求的响应时间变成了 100ms，那么 整体的响应时间是 (100 * 100 + 9900 * 1) / 10000 = 1.99ms。所以平均值对于度量性能来说只能作为⼀个参考。 

#### 2. 最⼤值 

这个更好理解，就是这段时间内所有请求响应时间最⻓的值，它也有个问题，就是不能准确度量性能。

#### 3. 分位值

分位值有很多种，⽐如 90 分位、95 分位等。以 90 分位为例，我们把这段时间请 求的响应时间从⼩到⼤排序，假如⼀共有 100 个请求，那么排在第 90 位的响应时间就是 90 分位值。

说的通俗点就是90%的请求都能达到的响应时间，分位值排除了偶发极慢请求对于数据的影响，能够很好地反应这段时间的性能 情况，分位值越⼤，对于慢请求的影响就越敏感。

在我来看，分位值是最适合作为时间段内，响应时间统计值来使⽤的，在实际⼯作中也应⽤ 最多。除此之外，平均值也可以作为⼀个参考值来使⽤。 

脱离了并发来谈性能是没有意义的，我们通常使⽤吞吐量和响应时间来度量并发和流量，使⽤吞吐量的情况会更多⼀些。但是你要知道，这两个指标是呈倒数关系的。

这很好理解，响应时间 1s 时，吞吐量是每秒 1 次，响应时间缩短到 10ms，那么吞吐量就 上升到每秒 100 次。所以，⼀般我们度量性能时都会同时兼顾吞吐量和响应时间，⽐如我 们设⽴性能优化的⽬标时通常会这样表述：在每秒 1 万次的请求量下，响应时间 99 分位值 在 10ms 以下。

那么，响应时间究竟控制在多⻓时间⽐较合适呢？这个不能⼀概⽽论。 从⽤户使⽤体验的⻆度来看，200ms 是⼀个分界点，⽤户是感觉不到延迟的，就像是瞬时发⽣的⼀样；超过 1s 之后⽤户就 会有明显等待的感觉，等待时间越⻓，⽤户的使⽤体验就越差。

### ⾼并发下的性能优化 

假如说，你现在有⼀个系统，这个系统中处理核⼼只有⼀个，执⾏的任务的响应时间都在 10ms，它的吞吐量是在每秒 100 次。那么我们如何来优化性能从⽽提⾼系统的并发能⼒ 呢？主要有两种思路：⼀种是提⾼系统的处理核⼼数，另⼀种是减少单次任务的响应时间。

#### 1. 提⾼系统的处理核⼼数

就是增加系统的并⾏处理能⼒，这个思路是优化性能最简单的途径。

是不是⽆限制地增加处理核⼼数就能⽆限制地提升性能， 从⽽提升系统处理⾼并发的能⼒呢？很遗憾，随着并发进程数的增加，并⾏的任务对于系统 资源的争抢也会愈发严重。在某⼀个临界点上继续增加并发进程数，反⽽会造成系统性能的 下降，这就是性能测试中的拐点模型。

####  减少单次任务响应时间 

想要减少任务的响应时间，⾸先要看你的系统是 CPU 密集型还是 IO 密集型的，因为不同 类型的系统性能优化⽅式不尽相同。

CPU 密集型系统中，需要处理⼤量的 CPU 运算，那么选⽤更⾼效的算法或者减少运算次 数就是这类系统重要的优化⼿段。

IO 密集型系统指的是系统的⼤部分操作是在等待 IO 完成，这⾥ IO 指的是磁盘 IO 和⽹络 IO。我们熟知的系统⼤部分都属于 IO 密集型，⽐如数据库系统、缓存系统、Web 系统。 如果是数据库访问慢，那么就要看是不是有锁表的情况、是不是有全表扫描、索引加的 是否合适；是否需要加缓存；是否需要异步，逻辑是否可以优化等。