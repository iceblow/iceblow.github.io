---
layout: post
title: 1000万条数据如何插入数据库
categories: [面试]
description: some word here
keywords: keyword1, keyword2
---

### 技术栈

Springboot、mybatisPlus、mysql

### 表结构

非常简单的一张表，没有其它索引字段，字段长度都较小。

使用InnoDB引擎，l已开启binlog，其他配置均为默认。

实例是本地数据库

```mysql
CREATE TABLE `test_insert_1000w` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键',
  `create_time` datetime NOT NULL COMMENT '创建时间',
  `create_by` varchar(32) DEFAULT NULL COMMENT '创建人',
  `update_time` datetime DEFAULT NULL COMMENT '创建时间',
  `update_by` varchar(32) DEFAULT NULL COMMENT '修改人',
  `delete_status` tinyint(2) NOT NULL DEFAULT '0' COMMENT '删除否？0：否，1:是',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
```

### 测试

#### 测试一

每次批量插入1000或2000条，同事开启打印SQL日志。

为准确衡量，数据量小的会测试5次去中位数。

| 总数  | 次数  | 批量插入数(打印SQL) | 耗时ms            |
| ----- | ----- | ------------------- | ----------------- |
| 1W    | 10    | 1000                | 1952              |
|       |       |                     | 1422              |
|       |       |                     | 1539              |
|       |       |                     | 1516              |
|       |       |                     | 1533              |
|       |       |                     | 平均 1.53s        |
|       |       |                     |                   |
| 2W    | 10    | 2000                | 4484              |
|       |       |                     | 4168              |
|       |       |                     | 4165              |
|       |       |                     | 4164              |
|       |       |                     | 4236              |
|       |       |                     | 平均 4.17s        |
|       |       |                     |                   |
| 1000W | 10000 | 1000                | 2074044ms = 34min |

可以看到每次批量插入的数量由1000提高到2000时，数量增加一倍，但是耗时增加近3倍，批量插入的数据不是越大越好，数据量过大可能超过每次执行SQL的最大长度。

1000万的数据量，竟然耗时半小时，这是超出意料之外的。

#### 测试二

不开启日志打印，结果如下：

| 总数  | 次数  | 批量插入数（不打印SQL） | 耗时ms     |
| ----- | ----- | ----------------------- | ---------- |
| 1W    | 10    | 1000                    | 1559       |
|       |       |                         | 1252       |
|       |       |                         | 1228       |
|       |       |                         | 1241       |
|       |       |                         | 1230       |
|       |       |                         | 平均1.24s  |
|       |       |                         |            |
| 10W   | 100   | 1000                    | 17901      |
|       |       |                         | 17495      |
|       |       |                         | 17627      |
|       |       |                         | 18482      |
|       |       |                         | 17627      |
|       |       |                         | 平均 17.5s |
|       |       |                         |            |
| 1000W | 10000 | 1000                    | 未测试     |

关闭打印SQL日志，性能有所提升。

数据量较大时性能下降严重。

// TODO 
